<?xml version="1.0" encoding="UTF-8"?>
<Flow xmlns="http://soap.sforce.com/2006/04/metadata">
    <apiVersion>55.0</apiVersion>
    <assignments>
        <name>Add_RA_to_Collection</name>
        <label>Add RA to Collection</label>
        <locationX>333</locationX>
        <locationY>1058</locationY>
        <assignmentItems>
            <assignToReference>ResourceAbsences_Dedup</assignToReference>
            <operator>Add</operator>
            <value>
                <elementReference>Check_for_Duplicates</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>RAIds</assignToReference>
            <operator>Add</operator>
            <value>
                <elementReference>Check_for_Duplicates.Id</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Check_for_Duplicates</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Add_Resource_Absence_to_Collection_Variable</name>
        <label>Add Resource Absence to Collection Variable</label>
        <locationX>876</locationX>
        <locationY>840</locationY>
        <assignmentItems>
            <assignToReference>ResourceAbsenceCollection</assignToReference>
            <operator>Add</operator>
            <value>
                <elementReference>Get_Resource_Absence</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Loop_Over_Shifts</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Add_to_STM_Collection_Variable</name>
        <label>Add to STM Collection Variable</label>
        <locationX>1970</locationX>
        <locationY>1702</locationY>
        <assignmentItems>
            <assignToReference>STMs</assignToReference>
            <operator>Add</operator>
            <value>
                <elementReference>Get_Primary_STM</elementReference>
            </value>
        </assignmentItems>
    </assignments>
    <assignments>
        <name>Assign_Service_Appointment_to_Collection</name>
        <label>Assign Service Appointment to Collection</label>
        <locationX>1430</locationX>
        <locationY>739</locationY>
        <assignmentItems>
            <assignToReference>ServiceAppointments</assignToReference>
            <operator>Add</operator>
            <value>
                <elementReference>Get_Service_Appointments</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Get_Resource_Absence</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Assign_Service_Appointment_Variables</name>
        <label>Assign Service Appointment Variables</label>
        <locationX>1409</locationX>
        <locationY>547</locationY>
        <assignmentItems>
            <assignToReference>Get_Service_Appointments.Status</assignToReference>
            <operator>Assign</operator>
            <value>
                <stringValue>Dispatched</stringValue>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Assign_Service_Appointment_to_Collection</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Assign_STM_Updates</name>
        <label>Assign STM Updates</label>
        <locationX>1838</locationX>
        <locationY>1557</locationY>
        <assignmentItems>
            <assignToReference>Get_Primary_STM.City</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>Get_Service_Region_Center_Address.Service_Region_City</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>Get_Primary_STM.State</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>Get_Service_Region_Center_Address.Service_Region_State</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>Get_Primary_STM.PostalCode</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>Get_Service_Region_Center_Address.Service_Region_Zip</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Add_to_STM_Collection_Variable</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Update_Resource_Absence</name>
        <label>Update Resource Absence</label>
        <locationX>1035</locationX>
        <locationY>885</locationY>
        <assignmentItems>
            <assignToReference>Get_Resource_Absence.Start</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>$Flow.CurrentDateTime</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>Get_Resource_Absence.End</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>CurrentTimePlus1Min</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Add_Resource_Absence_to_Collection_Variable</targetReference>
        </connector>
    </assignments>
    <decisions>
        <name>Did_Get_Resource_Absence_Return_a_Record</name>
        <label>Did Get Resource Absence Return a Record</label>
        <locationX>1142</locationX>
        <locationY>934</locationY>
        <defaultConnector>
            <targetReference>Loop_Over_Shifts</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>No</defaultConnectorLabel>
        <rules>
            <name>Yes</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>Get_Resource_Absence</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Update_Resource_Absence</targetReference>
            </connector>
            <label>Yes</label>
        </rules>
    </decisions>
    <decisions>
        <name>Is_RA_already_in_Collection</name>
        <label>Is RA already in Collection?</label>
        <locationX>533</locationX>
        <locationY>1064</locationY>
        <defaultConnector>
            <targetReference>Add_RA_to_Collection</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>No</defaultConnectorLabel>
        <rules>
            <name>Yes_RA_in_Collection</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>RAIds</leftValueReference>
                <operator>Contains</operator>
                <rightValue>
                    <elementReference>Check_for_Duplicates.Id</elementReference>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Check_for_Duplicates</targetReference>
            </connector>
            <label>Yes</label>
        </rules>
    </decisions>
    <decisions>
        <name>Was_Primary_STM_Found</name>
        <label>Was Primary STM Found?</label>
        <locationX>1826</locationX>
        <locationY>1267</locationY>
        <defaultConnectorLabel>No</defaultConnectorLabel>
        <rules>
            <name>Yes_STM_Found</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>Get_Primary_STM</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Get_Service_Region_Center_Address</targetReference>
            </connector>
            <label>Yes</label>
        </rules>
    </decisions>
    <decisions>
        <name>Were_records_found</name>
        <label>Were records found?</label>
        <locationX>1271</locationX>
        <locationY>454</locationY>
        <defaultConnector>
            <targetReference>Assign_Service_Appointment_Variables</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>Yes</defaultConnectorLabel>
        <rules>
            <name>No</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>Get_Service_Appointments.Id</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Get_Resource_Absence</targetReference>
            </connector>
            <label>No</label>
        </rules>
    </decisions>
    <environments>Default</environments>
    <formulas>
        <name>CurrentTimePlus1Min</name>
        <dataType>DateTime</dataType>
        <expression>{!$Flow.CurrentDateTime} + (1/1440)</expression>
    </formulas>
    <formulas>
        <name>CurrentTimePlus50</name>
        <dataType>DateTime</dataType>
        <expression>{!$Flow.CurrentDateTime} + (50/24/60)</expression>
    </formulas>
    <formulas>
        <name>CurrentTimePlus70</name>
        <dataType>DateTime</dataType>
        <expression>{!$Flow.CurrentDateTime} + (70/24/60)</expression>
    </formulas>
    <interviewLabel>Dispatch First Appointment of Shift {!$Flow.CurrentDateTime}</interviewLabel>
    <label>Dispatch First Appointment of Shift</label>
    <loops>
        <name>Check_for_Duplicates</name>
        <label>Check for Duplicates</label>
        <locationX>459</locationX>
        <locationY>704</locationY>
        <collectionReference>ResourceAbsenceCollection</collectionReference>
        <iterationOrder>Asc</iterationOrder>
        <nextValueConnector>
            <targetReference>Is_RA_already_in_Collection</targetReference>
        </nextValueConnector>
        <noMoreValuesConnector>
            <targetReference>Update_Resource_Absences_Deduped</targetReference>
        </noMoreValuesConnector>
    </loops>
    <loops>
        <name>Loop_Over_Shifts</name>
        <label>Loop Over Shifts</label>
        <locationX>895</locationX>
        <locationY>446</locationY>
        <collectionReference>Get_Shifts</collectionReference>
        <iterationOrder>Asc</iterationOrder>
        <nextValueConnector>
            <targetReference>Get_Service_Appointments</targetReference>
        </nextValueConnector>
        <noMoreValuesConnector>
            <targetReference>Update_Service_Appointments</targetReference>
        </noMoreValuesConnector>
    </loops>
    <processMetadataValues>
        <name>BuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>CanvasMode</name>
        <value>
            <stringValue>FREE_FORM_CANVAS</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>OriginBuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processType>AutoLaunchedFlow</processType>
    <recordLookups>
        <name>Get_Last_Known_Location_Record_Type</name>
        <label>Get Last Known Location Record Type</label>
        <locationX>895</locationX>
        <locationY>326</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Loop_Over_Shifts</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>SobjectType</field>
            <operator>EqualTo</operator>
            <value>
                <stringValue>ResourceAbsence</stringValue>
            </value>
        </filters>
        <filters>
            <field>Name</field>
            <operator>EqualTo</operator>
            <value>
                <stringValue>Non Availability</stringValue>
            </value>
        </filters>
        <getFirstRecordOnly>true</getFirstRecordOnly>
        <object>RecordType</object>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <recordLookups>
        <name>Get_Primary_STM</name>
        <label>Get Primary STM</label>
        <locationX>1937</locationX>
        <locationY>1097</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Was_Primary_STM_Found</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>ServiceResourceId</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>Loop_Over_Shifts.ServiceResourceId</elementReference>
            </value>
        </filters>
        <filters>
            <field>TerritoryType</field>
            <operator>EqualTo</operator>
            <value>
                <stringValue>P</stringValue>
            </value>
        </filters>
        <getFirstRecordOnly>true</getFirstRecordOnly>
        <object>ServiceTerritoryMember</object>
        <sortField>CreatedDate</sortField>
        <sortOrder>Desc</sortOrder>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <recordLookups>
        <name>Get_Resource_Absence</name>
        <label>Get Resource Absence</label>
        <locationX>1293</locationX>
        <locationY>933</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Did_Get_Resource_Absence_Return_a_Record</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>ResourceId</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>Loop_Over_Shifts.ServiceResourceId</elementReference>
            </value>
        </filters>
        <filters>
            <field>RecordTypeId</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>Get_Last_Known_Location_Record_Type.Id</elementReference>
            </value>
        </filters>
        <filters>
            <field>Last_Known_Location__c</field>
            <operator>EqualTo</operator>
            <value>
                <booleanValue>true</booleanValue>
            </value>
        </filters>
        <getFirstRecordOnly>true</getFirstRecordOnly>
        <object>ResourceAbsence</object>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <recordLookups>
        <name>Get_Service_Appointments</name>
        <label>Get Service Appointments</label>
        <locationX>1134</locationX>
        <locationY>436</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Were_records_found</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Service_Resource_Shift__c</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>Loop_Over_Shifts.Id</elementReference>
            </value>
        </filters>
        <filters>
            <field>Status</field>
            <operator>EqualTo</operator>
            <value>
                <stringValue>Scheduled</stringValue>
            </value>
        </filters>
        <getFirstRecordOnly>true</getFirstRecordOnly>
        <object>ServiceAppointment</object>
        <sortField>SchedStartTime</sortField>
        <sortOrder>Asc</sortOrder>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <recordLookups>
        <name>Get_Shifts</name>
        <label>Get Shifts</label>
        <locationX>898</locationX>
        <locationY>205</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Get_Last_Known_Location_Record_Type</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>StartTime</field>
            <operator>GreaterThan</operator>
            <value>
                <elementReference>$Flow.CurrentDateTime</elementReference>
            </value>
        </filters>
        <filters>
            <field>StartTime</field>
            <operator>LessThan</operator>
            <value>
                <elementReference>CurrentTimePlus70</elementReference>
            </value>
        </filters>
        <getFirstRecordOnly>false</getFirstRecordOnly>
        <object>Shift</object>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <recordUpdates>
        <name>Update_Resource_Absences</name>
        <label>Update Resource Absences</label>
        <locationX>653</locationX>
        <locationY>709</locationY>
        <faultConnector>
            <targetReference>Check_for_Duplicates</targetReference>
        </faultConnector>
        <inputReference>ResourceAbsenceCollection</inputReference>
    </recordUpdates>
    <recordUpdates>
        <name>Update_Resource_Absences_Deduped</name>
        <label>Update Resource Absences (Deduped)</label>
        <locationX>217</locationX>
        <locationY>713</locationY>
        <connector>
            <targetReference>Update_Service_Appointments_0</targetReference>
        </connector>
        <inputReference>ResourceAbsences_Dedup</inputReference>
    </recordUpdates>
    <recordUpdates>
        <name>Update_Service_Appointments</name>
        <label>Update Service Appointments</label>
        <locationX>676</locationX>
        <locationY>502</locationY>
        <connector>
            <targetReference>Update_Resource_Absences</targetReference>
        </connector>
        <inputReference>ServiceAppointments</inputReference>
    </recordUpdates>
    <recordUpdates>
        <name>Update_Service_Appointments_0</name>
        <label>Update Service Appointments</label>
        <locationX>50</locationX>
        <locationY>715</locationY>
        <inputReference>ServiceAppointments</inputReference>
    </recordUpdates>
    <recordUpdates>
        <name>Update_STMs</name>
        <label>Update STMs</label>
        <locationX>1934</locationX>
        <locationY>1885</locationY>
        <inputReference>STMs</inputReference>
    </recordUpdates>
    <start>
        <locationX>770</locationX>
        <locationY>85</locationY>
        <connector>
            <targetReference>Get_Shifts</targetReference>
        </connector>
    </start>
    <status>Active</status>
    <subflows>
        <name>Get_Service_Region_Center_Address</name>
        <label>Get Service Region Center Address</label>
        <locationX>1963</locationX>
        <locationY>1395</locationY>
        <connector>
            <targetReference>Assign_STM_Updates</targetReference>
        </connector>
        <flowName>Get_Service_Region_Center_Address</flowName>
        <inputAssignments>
            <name>Service_Region</name>
            <value>
                <elementReference>Loop_Over_Shifts.Service_Region__c</elementReference>
            </value>
        </inputAssignments>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </subflows>
    <variables>
        <name>Count</name>
        <dataType>Number</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <scale>0</scale>
        <value>
            <numberValue>0.0</numberValue>
        </value>
    </variables>
    <variables>
        <name>NewResourceAbsences</name>
        <dataType>SObject</dataType>
        <isCollection>true</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>ResourceAbsence</objectType>
    </variables>
    <variables>
        <name>RAIds</name>
        <dataType>String</dataType>
        <isCollection>true</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
    </variables>
    <variables>
        <name>ResourceAbsence</name>
        <dataType>SObject</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>ResourceAbsence</objectType>
    </variables>
    <variables>
        <name>ResourceAbsenceCollection</name>
        <dataType>SObject</dataType>
        <isCollection>true</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>ResourceAbsence</objectType>
    </variables>
    <variables>
        <name>ResourceAbsences_Dedup</name>
        <dataType>SObject</dataType>
        <isCollection>true</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>ResourceAbsence</objectType>
    </variables>
    <variables>
        <name>ServiceAppointments</name>
        <dataType>SObject</dataType>
        <isCollection>true</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>ServiceAppointment</objectType>
    </variables>
    <variables>
        <name>STMs</name>
        <dataType>SObject</dataType>
        <isCollection>true</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>ServiceTerritoryMember</objectType>
    </variables>
</Flow>
